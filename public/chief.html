<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chief Guest - Light the Lamp</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
</head>
<style>
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes pulseGlow {

        0%,
        100% {
            filter: drop-shadow(0 0 8px rgba(255, 200, 0, 0.6));
        }

        50% {
            filter: drop-shadow(0 0 16px rgba(255, 200, 0, 0.9));
        }
    }

    .animate-fadeIn {
        animation: fadeIn 1s ease-in-out forwards;
    }

    .glow-pulse {
        animation: pulseGlow 2s infinite ease-in-out;
    }

    /* ðŸ”¥ Smooth lamp fade-in */
    .lamp-lit {
        transition: background-color 1s ease, border-color 1s ease, box-shadow 1s ease;
    }
</style>

<body
    class="bg-gradient-to-br from-yellow-50 via-white to-yellow-100 min-h-screen flex flex-col items-center justify-center">

    <!-- Header -->
    <div class="text-center mb-10">
        <h1 id="eventHeader" class="text-3xl font-bold text-yellow-800">âœ¨ Welcome âœ¨</h1>
        <p class="text-lg text-gray-600 mt-2">Click on one lamp to light it</p>
    </div>

    <!-- Celebration Overlay -->
    <div id="celebrationOverlay"
        class="fixed inset-0 hidden bg-black/30 flex flex-col items-center justify-center z-50">
        <div id="celebrationAnim" class="w-full h-full"></div>
        <!-- Typing Message -->
        <div id="typingMessage" class="fixed inset-0 flex items-center justify-center z-[60]
      text-center text-3xl md:text-5xl font-extrabold tracking-wide
      bg-clip-text text-transparent bg-gradient-to-r from-black to-gray-800
      drop-shadow-[0_0_35px_rgba(0,0,0,0.9)] animate-fadeIn">
        </div>
    </div>

    <!-- Lamp Circle -->
    <!-- <div id="lampContainer"
        class="relative w-[400px] h-[400px] flex items-center justify-center bg-center bg-no-repeat rounded-full"
        style="background-image: url('/images/bgsvg.svg'); background-size: 200px 200px;">
    </div> -->
    <div id="lampContainer" class="relative w-[400px] h-[400px] flex items-center justify-center rounded-full">

        <!-- Central Lottie animation -->
        <div id="centralAnim" class="absolute w-[200px] h-[200px]"></div>
    </div>
    <div id="status" class="mt-14 text-center text-gray-700 text-lg"></div>

    <script>
        const socket = io();
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get("roomId");
        const eventName = urlParams.get("eventName") || "the Event";
        document.getElementById("eventHeader").textContent = `âœ¨ Welcome to ${eventName} âœ¨`;
        const lampContainer = document.getElementById("lampContainer");
        const statusEl = document.getElementById("status");

        let lamps = [];
        let alreadyLit = false;
        // Central Lottie animation
        const centralAnimContainer = document.getElementById("centralAnim");

        lottie.loadAnimation({
            container: centralAnimContainer,
            renderer: "svg",
            loop: true,
            autoplay: true,
            path: "/animations/Rangoli.json" // your animation file here
        });

        function typeMessage(element, message, speed = 80) {
            element.textContent = "";
            // element.classList.remove("animate-fadeIn");
            // void element.offsetWidth; // re-trigger CSS animation
            // element.classList.add("animate-fadeIn");

            let i = 0;
            function typeChar() {
                if (i < message.length) {
                    element.textContent += message.charAt(i);
                    i++;
                    setTimeout(typeChar, speed);
                }
            }
            typeChar();
        }

        function renderLamps(lampCount, lampStates) {
            const existingLamps = lampContainer.querySelectorAll(".lamp");
            existingLamps.forEach(lamp => lamp.remove());

            // lampContainer.innerHTML = "";
            const radius = 180;
            const centerX = 200;
            const centerY = 200;

            lamps = lampStates;

            for (let i = 0; i < lampCount; i++) {
                const angle = (i / lampCount) * 2 * Math.PI;
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);

                const lamp = document.createElement("div");
                lamp.className = `absolute w-20 h-20 rounded-full shadow-lg border-6 flex items-center justify-center transition-colors duration-700 ease-in-out lamp-lit 
          ${lampStates[i]
                        ? "bg-yellow-300 border-amber-600 shadow-[0_0_25px_rgba(255,200,0,0.8)]"
                        : "bg-gray-300 border-gray-500 shadow-md"
                    }`;
                lamp.style.left = `${x - 40}px`;
                lamp.style.top = `${y - 40}px`;

                if (lampStates[i]) {
                    // ðŸ”¥ Smooth fade for fire
                    const animContainer = document.createElement("div");
                    animContainer.style.width = "60px";
                    animContainer.style.height = "60px";
                    animContainer.className = "opacity-0 transition-opacity duration-1000 ease-in-out";
                    lamp.appendChild(animContainer);

                    lottie.loadAnimation({
                        container: animContainer,
                        renderer: "svg",
                        loop: true,
                        autoplay: true,
                        path: "/animations/Fire.json"
                    });
                    setTimeout(() => animContainer.classList.add("opacity-100"), 50);
                } else {
                    lamp.textContent = "ðŸª”";
                }

                if (!lampStates[i] && !alreadyLit) {
                    lamp.addEventListener("click", () => {
                        socket.emit("light-lamp", { roomId, index: i });
                        alreadyLit = true;
                        statusEl.textContent = "You have lit your lamp. Thank you!";
                    });
                }

                lampContainer.appendChild(lamp);
            }

            // âœ… Check if all lamps are lit
            if (lampStates.every(state => state === true)) {
                statusEl.textContent = "ðŸŒŸ All lamps are lit! What a beautiful sight! ðŸŒŸ";
                const overlay = document.getElementById("celebrationOverlay");
                const animContainer = document.getElementById("celebrationAnim");
                const typingBox = document.getElementById("typingMessage");

                if (overlay.classList.contains("hidden")) {
                    // ðŸŽ­ Add delay before celebration
                    setTimeout(() => {
                        overlay.classList.remove("hidden");

                        lottie.loadAnimation({
                            container: animContainer,
                            renderer: "svg",
                            loop: false,
                            autoplay: true,
                            path: "/animations/Confetti.json"
                        });

                        const message = "The event has started! Let's go and celebrate our things together!";
                        typeMessage(typingBox, message, 60);

                        setTimeout(() => {
                            overlay.classList.add("hidden");
                            typingBox.textContent = "";
                            animContainer.innerHTML = "";
                        }, 7000);

                        socket.emit("event-started", { roomId, message });
                    }, 1500); // â³ 1.5s delay before celebration
                }
            } else {
                statusEl.textContent = "âœ¨ The lamps are being lit! âœ¨";
            }
        }

        socket.emit("join-room", { roomId });

        socket.on("room-data", ({ lamps, lampStates }) => {
            renderLamps(lamps, lampStates);
        });

        socket.on("lamp-updated", ({ lampStates }) => {
            renderLamps(lampStates.length, lampStates);
        });

        socket.on("event-started", ({ message }) => {
            const overlay = document.getElementById("celebrationOverlay");
            const typingBox = document.getElementById("typingMessage");
            overlay.classList.remove("hidden");
        });
    </script>
</body>

</html>